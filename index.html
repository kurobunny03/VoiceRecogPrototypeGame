<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Sonic Fingerprint AI Lab</title>
  <style>
    * { box-sizing: border-box; }
    
    body { 
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
      background: linear-gradient(135deg, #0a0a0a 0%, #1a1a2e 100%); 
      color: white; 
      margin: 0; 
      padding: 0;
      min-height: 100vh;
    }

    #container { 
      display: flex; 
      flex-direction: column; 
      align-items: center; 
      padding: 20px; 
      max-width: 1200px;
      margin: 0 auto;
    }

    /* Header Styles */
    .header {
      text-align: center;
      margin-bottom: 30px;
      width: 100%;
    }

    .header h1 {
      font-size: clamp(1.8rem, 5vw, 2.8rem);
      margin: 10px 0;
      text-shadow: 0 0 20px rgba(0, 212, 255, 0.6);
      background: linear-gradient(90deg, #00d4ff, #00ff88);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .header p {
      color: #aaa;
      font-size: 1rem;
      margin: 5px 0;
    }

    /* Stats Bar */
    .stats-bar {
      display: flex;
      gap: 20px;
      justify-content: center;
      flex-wrap: wrap;
      margin: 20px 0;
      padding: 15px;
      background: rgba(0, 0, 0, 0.3);
      border-radius: 10px;
      border: 1px solid #333;
    }

    .stat-item {
      text-align: center;
      padding: 10px 20px;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 8px;
      border: 1px solid #444;
    }

    .stat-label {
      font-size: 0.8rem;
      color: #888;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .stat-value {
      font-size: 1.8rem;
      font-weight: bold;
      color: #00d4ff;
      margin-top: 5px;
    }

    /* Canvas Styles */
    .canvas-container {
      position: relative;
      width: 100%;
      max-width: 700px;
      margin: 20px 0;
    }

    canvas {
      border: 2px solid #00d4ff;
      background: #000;
      border-radius: 12px;
      box-shadow: 0 0 30px rgba(0, 212, 255, 0.3);
      width: 100%;
      height: auto;
      display: block;
    }

    .canvas-label {
      position: absolute;
      top: 10px;
      left: 15px;
      background: rgba(0, 0, 0, 0.8);
      padding: 5px 12px;
      border-radius: 5px;
      font-size: 0.85rem;
      color: #00d4ff;
      border: 1px solid #00d4ff;
    }

    /* Recording Indicator */
    .recording-indicator {
      position: absolute;
      top: 10px;
      right: 15px;
      background: #ff0044;
      padding: 5px 12px;
      border-radius: 20px;
      font-size: 0.85rem;
      font-weight: bold;
      animation: pulse 1.5s infinite;
      display: none;
    }

    .recording-indicator.active {
      display: block;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.4; }
    }

    /* Gallery */
    .gallery {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
      gap: 15px;
      margin: 20px 0;
      background: #1a1a1a;
      padding: 20px;
      border-radius: 12px;
      border: 1px solid #333;
      width: 100%;
      max-width: 700px;
      min-height: 120px;
    }

    .captured-item {
      position: relative;
      text-align: center;
      opacity: 0;
      animation: fadeIn 0.5s forwards;
      background: rgba(255, 255, 255, 0.05);
      padding: 12px;
      border-radius: 8px;
      border: 1px solid #444;
      transition: transform 0.2s, box-shadow 0.2s;
      cursor: pointer;
    }

    .captured-item:hover {
      transform: translateY(-5px);
      box-shadow: 0 5px 20px rgba(0, 212, 255, 0.3);
      border-color: #00d4ff;
    }

    .captured-item canvas {
      border: 1px solid #555;
      width: 100%;
      height: 70px;
      border-radius: 6px;
      margin-bottom: 8px;
    }

    .captured-item .word-label {
      font-weight: bold;
      color: #00d4ff;
      font-size: 0.95rem;
      margin-bottom: 5px;
    }

    .captured-item .timestamp {
      font-size: 0.7rem;
      color: #666;
    }
    .delete-btn{
      position:absolute;
      top:6px; right:6px;
      width:22px; height:22px;
      border-radius:50%;
      border:1px solid #555;
      background: rgba(0,0,0,.65);
      color:#fff;
      font-weight:900;
      line-height:20px;
      cursor:pointer;
      z-index:5;
      padding:0;
    }
    .delete-btn:hover{ border-color:#ff4444; color:#ff4444; }
    /* Controls */
    .controls {
      margin: 20px 0;
      display: flex;
      gap: 12px;
      justify-content: center;
      flex-wrap: wrap;
      width: 100%;
      max-width: 700px;
    }

    button {
      padding: 14px 28px;
      font-size: 0.95rem;
      cursor: pointer;
      background: linear-gradient(135deg, #00d4ff, #0099cc);
      border: none;
      border-radius: 8px;
      font-weight: bold;
      color: #fff;
      transition: all 0.3s;
      text-transform: uppercase;
      letter-spacing: 1px;
      box-shadow: 0 4px 15px rgba(0, 212, 255, 0.3);
      position: relative;
      overflow: hidden;
    }

    button::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 0;
      height: 0;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.3);
      transform: translate(-50%, -50%);
      transition: width 0.6s, height 0.6s;
    }

    button:hover::before {
      width: 300px;
      height: 300px;
    }

    button:hover:not(:disabled) {
      transform: translateY(-3px);
      box-shadow: 0 6px 25px rgba(0, 212, 255, 0.5);
    }

    button:active:not(:disabled) {
      transform: translateY(-1px);
    }

    button:disabled {
      background: #333;
      color: #666;
      cursor: not-allowed;
      box-shadow: none;
      transform: none;
    }

    button.secondary {
      background: linear-gradient(135deg, #444, #333);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
    }

    button.danger {
      background: linear-gradient(135deg, #ff4444, #cc0000);
    }

    button.success {
      background: linear-gradient(135deg, #00ff88, #00cc66);
    }

    input {
      padding: 14px 20px;
      border-radius: 8px;
      border: 2px solid #333;
      background: #222;
      color: white;
      min-width: 200px;
      text-align: center;
      font-weight: bold;
      font-size: 1rem;
      transition: border-color 0.3s;
    }

    input:focus {
      border-color: #00d4ff;
      outline: none;
      box-shadow: 0 0 15px rgba(0, 212, 255, 0.3);
    }

    /* AI Feedback Box */
    .ai-feedback {
      background: linear-gradient(135deg, rgba(0, 32, 0, 0.95), rgba(0, 64, 32, 0.95));
      border-left: 4px solid #00ff88;
      padding: 20px;
      margin: 20px 0;
      font-family: 'Courier New', monospace;
      color: #00ff88;
      width: 100%;
      max-width: 700px;
      min-height: 60px;
      text-align: left;
      font-size: 0.9rem;
      line-height: 1.6;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
      border-radius: 0 8px 8px 0;
      position: relative;
      overflow: hidden;
    }

    .ai-feedback::before {
      content: 'ü§ñ AI ANALYSIS';
      position: absolute;
      top: 8px;
      right: 15px;
      font-size: 0.7rem;
      opacity: 0.5;
      font-family: 'Segoe UI', sans-serif;
    }

    .ai-feedback.loading::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0;
      height: 3px;
      background: #00ff88;
      animation: loading 1.5s infinite;
    }

    @keyframes loading {
      0% { width: 0%; }
      50% { width: 100%; }
      100% { width: 0%; }
    }

    /* Challenge Mode */
    #challenge-section {
      display: none;
      flex-direction: column;
      align-items: center;
      width: 100%;
      animation: slideIn 0.5s;
    }

    @keyframes slideIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    #challenge-ui {
      background: linear-gradient(135deg, #1a1a2e, #2a2a3e);
      padding: 30px;
      border-radius: 15px;
      border: 2px solid #444;
      max-width: 700px;
      width: 100%;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
    }

    .challenge-header {
      text-align: center;
      margin-bottom: 25px;
    }

    .challenge-header h2 {
      color: #ff00d4;
      margin: 0 0 10px 0;
      font-size: 2rem;
      text-shadow: 0 0 15px rgba(255, 0, 212, 0.5);
    }

    /* AI Match Meter */
    .ai-status {
      background: linear-gradient(135deg, #0a0a0a, #1a1a1a);
      padding: 20px;
      border-radius: 10px;
      margin: 20px 0;
      border: 1px solid #333;
    }

    .meter-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 0.9rem;
      color: #888;
      margin-bottom: 10px;
    }

    .meter-percentage {
      font-size: 1.5rem;
      color: white;
      font-weight: bold;
    }

    .meter-bg {
      background: #222;
      width: 100%;
      height: 12px;
      border-radius: 6px;
      overflow: hidden;
      box-shadow: inset 0 2px 5px rgba(0, 0, 0, 0.5);
    }

    #ai-meter-bar {
      height: 100%;
      background: linear-gradient(90deg, #00d4ff, #00ff88, #00ff88);
      width: 0%;
      transition: width 0.3s ease-out;
      box-shadow: 0 0 10px currentColor;
    }

    .meter-status {
      display: block;
      margin-top: 8px;
      color: #555;
      font-size: 0.85rem;
      text-align: center;
      font-weight: 600;
    }

    /* Dialog Panel */
    .dialog-panel {
      margin-top: 20px;
      padding: 20px;
      border: 1px solid #333;
      border-radius: 12px;
      background: linear-gradient(135deg, #0a0a0a, #1a1a1a);
    }

    .dialog-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 15px;
      margin-bottom: 15px;
      flex-wrap: wrap;
    }

    .dialog-stats {
      font-size: 0.9rem;
      color: #888;
      flex: 1;
    }

    .dialog-stats b {
      color: #fff;
    }

    #talkBtn {
      min-width: 140px;
      padding: 12px 20px;
      background: linear-gradient(135deg, #00ff88, #00cc66);
      font-size: 0.95rem;
    }

    #talkBtn:active:not(:disabled) {
      background: linear-gradient(135deg, #00cc66, #009944);
    }

    .dialog-transcript {
      margin-top: 15px;
      font-size: 0.9rem;
      line-height: 1.6;
    }

    .dialog-line {
      margin-bottom: 12px;
      padding: 10px;
      border-radius: 6px;
      background: rgba(255, 255, 255, 0.03);
    }

    .dialog-line-label {
      color: #666;
      font-size: 0.8rem;
      margin-bottom: 4px;
    }

    .dialog-line-content {
      color: #ddd;
    }

    /* Options Container */
    #options-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 12px;
      margin: 20px 0;
    }

    #options-container button {
      background: linear-gradient(135deg, #333, #222);
      padding: 16px;
      font-size: 1.1rem;
    }

    #options-container button:hover:not(:disabled) {
      background: linear-gradient(135deg, #444, #333);
    }

    /* Feedback */
    .feedback {
      margin-top: 20px;
      font-size: 1.4rem;
      font-weight: bold;
      min-height: 2em;
      text-shadow: 0 2px 8px rgba(0, 0, 0, 0.8);
      text-align: center;
      padding: 15px;
      border-radius: 8px;
      transition: all 0.3s;
    }

    .feedback.correct {
      color: #00ff88;
      background: rgba(0, 255, 136, 0.1);
      border: 1px solid #00ff88;
    }

    .feedback.incorrect {
      color: #ff4444;
      background: rgba(255, 68, 68, 0.1);
      border: 1px solid #ff4444;
    }

    /* Hints */
    .hint-box {
      background: linear-gradient(135deg, #1a1a00, #2a2a00);
      border: 1px dashed #666;
      padding: 15px;
      margin: 15px 0;
      font-size: 0.9rem;
      color: #ffaa00;
      border-radius: 8px;
      line-height: 1.5;
    }

    /* Utilities */
    .hidden { display: none !important; }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* Progress Bar */
    .progress-section {
      width: 100%;
      max-width: 700px;
      margin: 20px 0;
    }

    .progress-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }

    .progress-label {
      color: #888;
      font-size: 0.9rem;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .progress-count {
      color: white;
      font-weight: bold;
      font-size: 1.1rem;
    }

    .progress-bar-container {
      width: 100%;
      height: 8px;
      background: #222;
      border-radius: 4px;
      overflow: hidden;
      box-shadow: inset 0 2px 5px rgba(0, 0, 0, 0.5);
    }

    .progress-bar {
      height: 100%;
      background: linear-gradient(90deg, #00d4ff, #00ff88);
      width: 0%;
      transition: width 0.5s ease-out;
      box-shadow: 0 0 10px currentColor;
    }

    /* Responsive */
    @media (max-width: 768px) {
      .controls {
        flex-direction: column;
      }

      input, button {
        width: 100%;
      }

      .gallery {
        grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
      }

      .stats-bar {
        flex-direction: column;
        gap: 10px;
      }
    }

    /* Tooltips */
    .tooltip {
      position: relative;
      display: inline-block;
    }

    .tooltip .tooltiptext {
      visibility: hidden;
      width: 200px;
      background-color: #333;
      color: #fff;
      text-align: center;
      border-radius: 6px;
      padding: 8px;
      position: absolute;
      z-index: 1;
      bottom: 125%;
      left: 50%;
      margin-left: -100px;
      opacity: 0;
      transition: opacity 0.3s;
      font-size: 0.85rem;
    }

    .tooltip:hover .tooltiptext {
      visibility: visible;
      opacity: 1;
    }
  </style>
</head>

<body>
  <div id="container">
    <!-- Header -->
    <div class="header">
      <h1>üß¨ Sonic Fingerprint Lab</h1>
      <p>Explore how your voice creates unique audio patterns</p>
    </div>

    <!-- Stats Bar -->
    <div class="stats-bar" id="stats-bar" style="display: none;">
      <div class="stat-item">
        <div class="stat-label">Words Captured</div>
        <div class="stat-value" id="stat-words">0</div>
      </div>
      <div class="stat-item">
        <div class="stat-label">Score</div>
        <div class="stat-value" id="stat-score">0</div>
      </div>
      <div class="stat-item">
        <div class="stat-label">Difficulty</div>
        <div class="stat-value" id="stat-difficulty">1</div>
      </div>
    </div>

    <!-- Lab Section -->
    <div id="lab-section">
      <p style="color:#bbb; font-size: 1.05rem; margin-bottom: 20px;">
        Record <b style="color:#00d4ff;">4 different words</b> to build your voice dataset
      </p>

      <!-- Live Canvas -->
      <div class="canvas-container">
        <canvas id="liveCanvas"></canvas>
        <div class="canvas-label">LIVE SPECTRUM</div>
        <div class="recording-indicator" id="recording-indicator">‚óè REC</div>
      </div>

      <!-- AI Feedback -->
      <div class="ai-feedback" id="word-hint">
        Initialize microphone to begin spectral analysis...
      </div>

      <!-- Controls -->
      <div class="controls">
        <button id="startBtn" class="tooltip">
          <span>üé§ Start Microphone</span>
          <span class="tooltiptext">Grant microphone access to begin</span>
        </button>
        <input type="text" id="wordInput" placeholder="Type word (e.g., HELLO)" maxlength="20">
        <button id="captureBtn" disabled class="success">
          üì∏ Capture & Analyze
        </button>
      </div>

      <!-- Progress Section -->
      <div class="progress-section">
        <div class="progress-header">
          <span class="progress-label">Dataset Progress</span>
          <span class="progress-count"><span id="count">0</span>/4</span>
        </div>
        <div class="progress-bar-container">
          <div class="progress-bar" id="progress-bar"></div>
        </div>
      </div>

      <!-- Gallery -->
      <div class="gallery" id="gallery"></div>

      <!-- Action Buttons -->
      <div class="controls">
        <button id="goToChallengeBtn" disabled style="background: linear-gradient(135deg, #ff00d4, #cc0099); font-size: 1rem;">
          üéØ Enter Challenge Mode ‚Üí
        </button>
        <button id="resetLabBtn" class="secondary" style="font-size: 0.9rem;">
          üîÑ Reset Lab
        </button>
      </div>
    </div>

    <!-- Challenge Section -->
    <div id="challenge-section">
      <button id="backToLabBtn" class="secondary" style="margin-bottom: 25px; width: 100%; max-width: 700px;">
        ‚Üê Back to Lab
      </button>

      <div id="challenge-ui">
        <div class="challenge-header">
          <h2>üé≠ Mystery Pattern</h2>
          <p style="color: #aaa; margin: 0;">Can you identify which word created this pattern?</p>
        </div>

        <!-- Mystery Canvas -->
        <div class="canvas-container">
          <canvas id="mysteryCanvas"></canvas>
          <div class="canvas-label">MYSTERY SPECTRUM</div>
        </div>

        <!-- AI Match Meter -->
        <div class="ai-status">
          <div class="meter-header">
            <span>LIVE VOICE MATCH</span>
            <span class="meter-percentage"><span id="ai-percent">0</span>%</span>
          </div>
          <div class="meter-bg">
            <div id="ai-meter-bar"></div>
          </div>
          <small class="meter-status" id="ai-match-text">Speak to compare your voice...</small>
        </div>

        <!-- AI Oral Quiz -->
        <div class="dialog-panel">
          <div class="dialog-header">
            <div class="dialog-stats">
              <b>ü§ñ AI Oral Quiz</b><br>
              <span style="font-size: 0.85rem;">
                Difficulty: <span id="diff">1</span> ‚Ä¢ Points: <span id="pts">0</span>
              </span>
            </div>
            <button id="talkBtn">
              üéôÔ∏è Hold to Talk
            </button>
          </div>

          <div class="dialog-transcript">
            <div class="dialog-line">
              <div class="dialog-line-label">You said:</div>
              <div class="dialog-line-content" id="studentTranscript">‚Äî</div>
            </div>
            <div class="dialog-line">
              <div class="dialog-line-label">AI Response:</div>
              <div class="dialog-line-content" id="aiReply">‚Äî</div>
            </div>
            <div class="dialog-line">
              <div class="dialog-line-label">Next Question:</div>
              <div class="dialog-line-content" id="nextQ">Answer questions by voice to earn points üéØ</div>
            </div>
          </div>
        </div>

        <!-- Hint Box -->
        <div id="challenge-hint" class="hint-box hidden"></div>

        <!-- Options -->
        <div id="options-container"></div>

        <!-- Feedback -->
        <div id="feedback" class="feedback"></div>

        <!-- Next Button -->
        <button id="nextBtn" class="hidden success" style="width: 100%; font-size: 1.1rem;">
          Next Round ‚Üí
        </button>
      </div>
    </div>
  </div>

  <script>
    // ============================================
    // CONFIGURATION
    // ============================================
    const API_URL = "https://voicerecogprototypegame.onrender.com/analyze-sound";
    const DIALOG_URL = "https://voicerecogprototypegame.onrender.com/dialog";
    
    // ============================================
    // STATE MANAGEMENT
    // ============================================
    const state = {
      audioCtx: null,
      analyser: null,
      dataArray: null,
      library: [],
      currentTarget: null,
      isMicActive: false,
      score: 0,
      totalRounds: 0,
      dialogHistory: [],
      difficulty: 1,
      points: 0,
      recordingStream: null,
      mediaRecorder: null,
      audioChunks: [],
      isHolding: false
    };

    // ============================================
    // DOM ELEMENTS
    // ============================================
    const elements = {
      liveCanvas: document.getElementById('liveCanvas'),
      mysteryCanvas: document.getElementById('mysteryCanvas'),
      gallery: document.getElementById('gallery'),
      wordHint: document.getElementById('word-hint'),
      recordingIndicator: document.getElementById('recording-indicator'),
      startBtn: document.getElementById('startBtn'),
      captureBtn: document.getElementById('captureBtn'),
      wordInput: document.getElementById('wordInput'),
      goToChallengeBtn: document.getElementById('goToChallengeBtn'),
      resetLabBtn: document.getElementById('resetLabBtn'),
      backToLabBtn: document.getElementById('backToLabBtn'),
      labSection: document.getElementById('lab-section'),
      challengeSection: document.getElementById('challenge-section'),
      optionsContainer: document.getElementById('options-container'),
      feedback: document.getElementById('feedback'),
      nextBtn: document.getElementById('nextBtn'),
      challengeHint: document.getElementById('challenge-hint'),
      talkBtn: document.getElementById('talkBtn'),
      studentTranscript: document.getElementById('studentTranscript'),
      aiReply: document.getElementById('aiReply'),
      nextQ: document.getElementById('nextQ'),
      diff: document.getElementById('diff'),
      pts: document.getElementById('pts'),
      count: document.getElementById('count'),
      progressBar: document.getElementById('progress-bar'),
      statsBar: document.getElementById('stats-bar'),
      statWords: document.getElementById('stat-words'),
      statScore: document.getElementById('stat-score'),
      statDifficulty: document.getElementById('stat-difficulty'),
      aiPercent: document.getElementById('ai-percent'),
      aiMeterBar: document.getElementById('ai-meter-bar'),
      aiMatchText: document.getElementById('ai-match-text')
    };

    // Setup canvas contexts
    const liveCtx = elements.liveCanvas.getContext('2d', { willReadFrequently: true });
    const mysteryCtx = elements.mysteryCanvas.getContext('2d');

    elements.liveCanvas.width = elements.mysteryCanvas.width = 600;
    elements.liveCanvas.height = elements.mysteryCanvas.height = 200;

    // ============================================
    // AUDIO INITIALIZATION
    // ============================================
    async function initAudio() {
      if (state.audioCtx) return;

      try {
        showStatus('Requesting microphone access...', 'info');
        
        state.audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        state.analyser = state.audioCtx.createAnalyser();
        state.analyser.fftSize = 512;
        state.analyser.smoothingTimeConstant = 0.6;

        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        const source = state.audioCtx.createMediaStreamSource(stream);
        source.connect(state.analyser);

        state.dataArray = new Uint8Array(state.analyser.frequencyBinCount);
        state.isMicActive = true;
        
        showStatus('‚úì Microphone active. Ready to capture audio patterns!', 'success');
        elements.startBtn.disabled = true;
        elements.startBtn.innerHTML = '<span>‚úì Mic Active</span>';
        elements.captureBtn.disabled = false;
        
        draw();
      } catch (error) {
        console.error('Microphone error:', error);
        showStatus('‚ùå Microphone access denied. Please allow microphone access and try again.', 'error');
        alert("Microphone Error: " + error.message);
      }
    }

    // ============================================
    // VISUALIZATION
    // ============================================
    function draw() {
      if (!state.isMicActive) return;
      requestAnimationFrame(draw);
      
      state.analyser.getByteFrequencyData(state.dataArray);

      // Scroll effect
      const imgData = liveCtx.getImageData(0, 0, elements.liveCanvas.width, elements.liveCanvas.height - 2);
      liveCtx.putImageData(imgData, 0, 2);

      // Draw new frequency line
      const binsToShow = 80; // try 60‚Äì120
      const barWidth = elements.liveCanvas.width / binsToShow;
      const noiseFloor = 18;                 // raise/lower: higher = darker background
      const gamma = 1.6;                     // contrast: higher = stronger bright bands

      for (let i = 0; i < binsToShow; i++) {
        const val = state.dataArray[i];

        // 0..1 after noise floor
        let x = (val - noiseFloor) / (255 - noiseFloor);
        if (x < 0) x = 0;

        // contrast curve (more like real spectrogram intensity)
        x = Math.pow(x, gamma);

        const p = Math.floor(x * 255);

        // Scientific blue->cyan->yellow colormap
        let r = 0, g = 0, b = 0;

        if (x < 0.5) {
          // black -> blue -> cyan
          const t = x / 0.5;
          r = 0;
          g = Math.floor(255 * t);
          b = Math.floor(180 + 75 * t);
        } else {
          // cyan -> yellow
          const t = (x - 0.5) / 0.5;
          r = Math.floor(255 * t);
          g = 255;
          b = Math.floor(255 * (1 - t));
        }

        liveCtx.fillStyle = `rgb(${r}, ${g}, ${b})`;


        liveCtx.fillRect(i * barWidth, 0, barWidth, 2);
      }

      // Compare with target in challenge mode
      if (state.currentTarget && elements.challengeSection.style.display === 'flex') {
        compareLiveToTarget(state.dataArray, state.currentTarget.freq);
      }
    }

    // ============================================
    // WORD CAPTURE
    // ============================================
    async function captureWord() {
      const word = elements.wordInput.value.toUpperCase().trim();
      
      if (!word) {
        alert("Please type the word you are saying!");
        return;
      }

      if (state.library.some(item => item.word === word)) {
        alert("You've already captured this word! Please use a different word.");
        return;
      }

      const snap = liveCtx.getImageData(0, 0, elements.liveCanvas.width, elements.liveCanvas.height);
      const freqSnapshot = new Uint8Array(state.dataArray);

      showStatus(`Analyzing spectral data for "${word}"...`, 'loading');
      elements.captureBtn.disabled = true;
      elements.recordingIndicator.classList.add('active');

      let aiAnalysis = "Analysis unavailable (Offline Mode)";
      
      try {
        const response = await fetch(API_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            word: word,
            frequencies: Array.from(freqSnapshot).slice(0, 40)
          })
        });

        if (response.ok) {
          const data = await response.json();
          aiAnalysis = data.analysis;
          showStatus(`‚úì Analysis complete for "${word}"`, 'success');
          setTimeout(() => {
            showStatus(aiAnalysis, 'analysis');
          }, 500);
        } else {
          throw new Error("Server error");
        }
      } catch (error) {
        console.error('Analysis error:', error);
        showStatus('‚ö†Ô∏è Connection failed. Using offline mode.', 'error');
      }

      // Add to library
      state.library.push({
        word: word,
        data: snap,
        freq: freqSnapshot,
        analysis: aiAnalysis,
        timestamp: new Date().toLocaleTimeString()
      });

      addToGallery(word, snap, state.library.length - 1);
      updateProgress();
      
      elements.wordInput.value = "";
      elements.captureBtn.disabled = false;
      elements.recordingIndicator.classList.remove('active');
      
      // Show stats bar after first capture
      if (state.library.length === 1) {
        elements.statsBar.style.display = 'flex';
      }
    }

    // ============================================
    // GALLERY MANAGEMENT
    // ============================================
    function addToGallery(word, imageData, index) {
      const container = document.createElement('div');
      container.className = 'captured-item';
      container.setAttribute('data-index', index);

      // Delete button
      const del = document.createElement('button');
      del.className = 'delete-btn';
      del.type = 'button';
      del.textContent = '√ó';
      del.title = 'Delete';
      del.addEventListener('click', (e) => {
        e.stopPropagation();
        deleteCapture(Number(container.getAttribute('data-index')));
      });
      container.appendChild(del);

      // Create offscreen canvas for scaling
      const off = document.createElement('canvas');
      off.width = imageData.width;
      off.height = imageData.height;
      const offCtx = off.getContext('2d', { willReadFrequently: true });
      offCtx.putImageData(imageData, 0, 0);

      // Create thumbnail
      const miniCanvas = document.createElement('canvas');
      miniCanvas.width = 140;
      miniCanvas.height = 70;
      const miniCtx = miniCanvas.getContext('2d');
      miniCtx.imageSmoothingEnabled = true;
      miniCtx.clearRect(0, 0, miniCanvas.width, miniCanvas.height);
      miniCtx.drawImage(off, 0, 0, miniCanvas.width, miniCanvas.height);

      const wordLabel = document.createElement('div');
      wordLabel.className = 'word-label';
      wordLabel.textContent = word;

      const timestamp = document.createElement('div');
      timestamp.className = 'timestamp';
      timestamp.textContent = state.library[index].timestamp;

      container.appendChild(miniCanvas);
      container.appendChild(wordLabel);
      container.appendChild(timestamp);
      
      // Click to view details
      container.addEventListener('click', () => {
        showWordDetails(Number(container.getAttribute('data-index')));
      });


      elements.gallery.appendChild(container);
    }

    function showWordDetails(index) {
      const item = state.library[index];
      alert(`Word: ${item.word}\nCaptured: ${item.timestamp}\n\nAI Analysis:\n${item.analysis}`);
    }

    function deleteCapture(index) {
      if (!confirm(`Delete "${state.library[index]?.word}" from dataset?`)) return;

      // remove from dataset
      state.library.splice(index, 1);

      // remove from DOM
      const el = elements.gallery.querySelector(`[data-index="${index}"]`);
      if (el) el.remove();

      // reindex remaining DOM items so clicks still map correctly
      [...elements.gallery.querySelectorAll(".captured-item")].forEach((itemEl, newIdx) => {
        itemEl.setAttribute("data-index", newIdx);
      });

      // if you deleted the active target while in challenge, bail to lab safely
      if (state.currentTarget && !state.library.includes(state.currentTarget)) {
        switchToLab();
      }

      // update UI
      updateProgress();
      updateStats();
    }

    // ============================================
    // PATTERN MATCHING
    // ============================================
    function compareLiveToTarget(live, target) {
      // Calculate average volume
      let liveVol = live.reduce((sum, val) => sum + val, 0) / live.length;

      if (liveVol < 5) {
        updateMeter(0);
        return;
      }

      // Cosine similarity
      let dotProduct = 0;
      let magA = 0;
      let magB = 0;

      for (let i = 0; i < live.length; i++) {
        dotProduct += live[i] * target[i];
        magA += live[i] * live[i];
        magB += target[i] * target[i];
      }

      const magnitude = Math.sqrt(magA) * Math.sqrt(magB);
      if (magnitude === 0) {
        updateMeter(0);
        return;
      }

      const similarity = dotProduct / magnitude;

      // Map to percentage (0.7 = 0%, 1.0 = 100%)
      let percent = 0;
      if (similarity > 0.7) {
        percent = Math.min(100, ((similarity - 0.7) / 0.3) * 100);
      }

      updateMeter(Math.floor(percent));
    }

    function updateMeter(percent) {
      elements.aiPercent.innerText = percent;
      elements.aiMeterBar.style.width = percent + "%";

      const text = elements.aiMatchText;
      if (percent > 80) {
        text.innerText = "‚úì MATCH CONFIRMED";
        text.style.color = "#00ff88";
      } else if (percent > 40) {
        text.innerText = "üîç DETECTING PATTERN...";
        text.style.color = "#00d4ff";
      } else {
        text.innerText = "‚úï NO MATCH";
        text.style.color = "#555";
      }
    }

    // ============================================
    // CHALLENGE MODE
    // ============================================
    
    // Helper: Get initial question based on difficulty
    function getInitialQuestion(difficulty) {
      const questions = {
        1: [
          "What happens to the spectral pattern when you speak the same word louder?",
          "Which frequency range shows the most energy in this pattern?",
          "How does speaking at different pitches change the spectrum?"
        ],
        2: [
          "Why do vowel sounds typically show energy in the mid-frequency range?",
          "What causes the peaks and valleys in the frequency spectrum?",
          "How would whispering this word change the spectral pattern?"
        ],
        3: [
          "Explain the relationship between the fundamental frequency and harmonics you see here.",
          "Why might two different people saying this word create different patterns?",
          "What makes this word's spectral signature unique compared to others?"
        ],
        4: [
          "How do voiced sounds differ from unvoiced sounds in spectral characteristics?",
          "What role do formants play in distinguishing different vowel sounds?",
          "Why does the FFT display discrete bins rather than a continuous spectrum?"
        ],
        5: [
          "How would filtering affect the intelligibility of this word based on its spectrum?",
          "What spectral features would you use for speaker identification?",
          "Explain the time-frequency resolution trade-off in spectral analysis."
        ]
      };
      
      const questionList = questions[difficulty] || questions[1];
      return questionList[Math.floor(Math.random() * questionList.length)];
    }
    
    function startRound() {
      // Reset UI
      elements.feedback.innerHTML = "";
      elements.feedback.className = "feedback";
      elements.nextBtn.classList.add('hidden');
      elements.challengeHint.classList.add('hidden');
      elements.optionsContainer.innerHTML = "";

      // Select random target
      state.currentTarget = state.library[Math.floor(Math.random() * state.library.length)];
      mysteryCtx.putImageData(state.currentTarget.data, 0, 0);

      // Set initial question for AI quiz (only on first round)
      if (state.totalRounds === 0) {
        const initialQuestion = getInitialQuestion(state.difficulty);
        elements.nextQ.textContent = initialQuestion;
        elements.studentTranscript.textContent = "‚Äî";
        elements.aiReply.textContent = "Hold the talk button and answer the question above!";
      }

      // Create options for word matching game
      const decoys = state.library
        .filter(item => item.word !== state.currentTarget.word)
        .sort(() => 0.5 - Math.random())
        .slice(0, Math.min(2, state.library.length - 1));
      
      const choices = [state.currentTarget, ...decoys].sort(() => 0.5 - Math.random());

      choices.forEach(choice => {
        const btn = document.createElement('button');
        btn.innerText = choice.word;
        btn.onclick = () => checkAnswer(choice.word);
        elements.optionsContainer.appendChild(btn);
      });

      state.totalRounds++;
      
      // Reset meter
      updateMeter(0);
    }

    function checkAnswer(selectedWord) {
      // Disable all buttons
      document.querySelectorAll('#options-container button').forEach(btn => btn.disabled = true);

      const isCorrect = selectedWord === state.currentTarget.word;

      if (isCorrect) {
        state.score++;
        elements.feedback.innerHTML = "‚úì CORRECT! Great pattern recognition!";
        elements.feedback.className = "feedback correct";
      } else {
        elements.feedback.innerHTML = `‚úï INCORRECT. The answer was "${state.currentTarget.word}"`;
        elements.feedback.className = "feedback incorrect";

        // Show hint
        elements.challengeHint.classList.remove('hidden');
        elements.challengeHint.innerHTML = `
          <strong>üí° AI Lab Report:</strong><br>
          ${state.currentTarget.analysis}
        `;
      }

      elements.nextBtn.classList.remove('hidden');
      updateStats();
    }

    // ============================================
    // AI DIALOG (ORAL QUIZ)
    // ============================================
    async function ensureRecordingStream() {
      if (state.recordingStream) return state.recordingStream;
      state.recordingStream = await navigator.mediaDevices.getUserMedia({ audio: true });
      return state.recordingStream;
    }

    async function startRecording() {
      if (!state.currentTarget) {
        elements.aiReply.textContent = "Enter Challenge Mode first to use the AI quiz üôÇ";
        return;
      }

      elements.talkBtn.disabled = true;
      elements.talkBtn.textContent = "üéôÔ∏è Recording...";
      state.audioChunks = [];

      const stream = await ensureRecordingStream();
      state.mediaRecorder = new MediaRecorder(stream, { mimeType: 'audio/webm' });

      state.mediaRecorder.ondataavailable = (e) => {
        if (e.data && e.data.size > 0) {
          state.audioChunks.push(e.data);
        }
      };

      state.mediaRecorder.start();
      setTimeout(() => { elements.talkBtn.disabled = false; }, 120);
    }

    async function stopRecordingAndSend() {
      if (!state.mediaRecorder) return;

      elements.talkBtn.disabled = true;
      elements.talkBtn.textContent = "‚è≥ AI Thinking...";

      const stopped = new Promise((resolve) => {
        state.mediaRecorder.onstop = resolve;
      });

      state.mediaRecorder.stop();
      await stopped;

      const blob = new Blob(state.audioChunks, { type: 'audio/webm' });
      
      if (blob.size < 800) {
        elements.talkBtn.disabled = false;
        elements.talkBtn.textContent = "üéôÔ∏è Hold to Talk";
        elements.aiReply.textContent = "I didn't catch that‚Äîtry speaking a bit louder üôÇ";
        return;
      }

      const ctx = {
        mode: "challenge",
        targetWord: state.currentTarget?.word || null,
        fft: state.currentTarget?.freq ? Array.from(state.currentTarget.freq).slice(0, 40) : null,
        analysisText: state.currentTarget?.analysis || "",
        difficulty: state.difficulty,
        points: state.points,
        history: state.dialogHistory
      };

      const form = new FormData();
      form.append("audio", blob, "answer.webm");
      form.append("context", JSON.stringify(ctx));

      try {
        const resp = await fetch(DIALOG_URL, {
          method: "POST",
          body: form
        });

        if (!resp.ok) throw new Error("Dialog request failed");
        
        const data = await resp.json();

        elements.studentTranscript.textContent = data.transcript || "(no transcript)";
        elements.aiReply.textContent = data.reply || "(no reply)";
        elements.nextQ.textContent = data.nextQuestion || "‚Äî";

        state.difficulty = data.difficulty ?? state.difficulty;
        state.points = data.totalPoints ?? state.points;
        
        elements.diff.textContent = state.difficulty;
        elements.pts.textContent = state.points;

        if (data.transcript) {
          state.dialogHistory.push({ role: "user", content: data.transcript });
        }
        if (data.reply) {
          state.dialogHistory.push({ role: "assistant", content: data.reply });
        }

        // Play TTS if available
        if (data.ttsAudioBase64 && data.ttsMime) {
          const bytes = Uint8Array.from(atob(data.ttsAudioBase64), c => c.charCodeAt(0));
          const audioBlob = new Blob([bytes], { type: data.ttsMime });
          const url = URL.createObjectURL(audioBlob);
          const audio = new Audio(url);
          audio.play().catch(console.error);
          audio.onended = () => URL.revokeObjectURL(url);
        }

        updateStats();
      } catch (error) {
        console.error('Dialog error:', error);
        elements.aiReply.textContent = "‚ö†Ô∏è Dialog failed. Check connection and try again.";
      } finally {
        elements.talkBtn.disabled = false;
        elements.talkBtn.textContent = "üéôÔ∏è Hold to Talk";
      }
    }

    // ============================================
    // UI HELPERS
    // ============================================
    function showStatus(message, type = 'info') {
      elements.wordHint.innerHTML = message;
      
      if (type === 'loading') {
        elements.wordHint.classList.add('loading');
      } else {
        elements.wordHint.classList.remove('loading');
      }
    }

    function updateProgress() {
      const count = state.library.length;
      elements.count.innerText = count;
      elements.statWords.innerText = count;
      
      const percentage = (count / 4) * 100;
      elements.progressBar.style.width = percentage + '%';
      
      elements.goToChallengeBtn.disabled = count < 4;
      
      if (count >= 4) {
        elements.goToChallengeBtn.style.boxShadow = "0 0 25px #ff00d4";
        showStatus('‚úì Dataset complete! Ready for Challenge Mode!', 'success');
      }
    }

    function updateStats() {
      elements.statScore.innerText = state.score;
      elements.statDifficulty.innerText = state.difficulty;
      elements.pts.innerText = state.points;
    }

    function switchToChallenge() {
      elements.labSection.classList.add('hidden');
      elements.challengeSection.style.display = 'flex';
      
      // Reset for new challenge session
      state.totalRounds = 0;
      state.score = 0;
      
      // Start first round (this will set initial question using getInitialQuestion)
      startRound();
      
      console.log('Challenge mode activated. Target word:', state.currentTarget?.word);
    }

    function switchToLab() {
      elements.challengeSection.style.display = 'none';
      elements.labSection.classList.remove('hidden');
      state.currentTarget = null;
    }

    // ============================================
    // EVENT LISTENERS
    // ============================================
    elements.startBtn.onclick = initAudio;
    elements.captureBtn.onclick = captureWord;
    elements.goToChallengeBtn.onclick = switchToChallenge;
    elements.backToLabBtn.onclick = switchToLab;
    elements.nextBtn.onclick = startRound;
    elements.resetLabBtn.onclick = () => {
      if (confirm('This will reset all your captured words and progress. Continue?')) {
        location.reload();
      }
    };

    // Word input - press Enter to capture
    elements.wordInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter' && !elements.captureBtn.disabled) {
        captureWord();
      }
    });

    // Talk button - hold to record
    let holding = false;

    elements.talkBtn.addEventListener("mousedown", async () => {
      holding = true;
      await startRecording();
    });

    elements.talkBtn.addEventListener("mouseup", async () => {
      if (!holding) return;
      holding = false;
      await stopRecordingAndSend();
    });

    elements.talkBtn.addEventListener("mouseleave", async () => {
      if (!holding) return;
      holding = false;
      await stopRecordingAndSend();
    });

    elements.talkBtn.addEventListener("touchstart", async (e) => {
      e.preventDefault();
      holding = true;
      await startRecording();
    }, { passive: false });

    elements.talkBtn.addEventListener("touchend", async (e) => {
      e.preventDefault();
      if (!holding) return;
      holding = false;
      await stopRecordingAndSend();
    }, { passive: false });

    // ============================================
    // INITIALIZATION
    // ============================================
    console.log('üß¨ Sonic Fingerprint Lab initialized');
    console.log('Ready to analyze voice patterns!');
  </script>
</body>
</html>